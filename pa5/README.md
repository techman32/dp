# PA5. Горизонтальное масштабирование хранилища данных: сегментирование (шардинг, sharding)

**Цель:** научиться применять шаблон "Сегментирование" для организации распределённого хранения данных

## Задание

*Задание делается на базе задания PA4*

Вводится новые понятия "Регион юрисдикции" и "Страна гражданства" пользователя.
Задача - для каждого региона юрисдикции выделяется отдельный сервер БД. Данные должны сохраняться на тех серверах, к региону которого относится страна пользователя.

На странице ввода текста добавляется поле ввода (Dropdown List) для указания страны пользователя.

Предплоложим, что в нашем приложении страны можно разбить на три региона:
1. RUS - Россия
2. EU - страны Евросоюза
3. OTHER - остальные страны

Соответственно идентификаторы регионов будут являться идентификаторами сегментов (*ShardID*).

И предположим, что пользователь может указать страну из следующего списка:
1. Russia - регион RUS
2. France - регион EU
3. Germany - регион EU
4. USA - регион OTHER
5. India - регион OTHER

В качестве хранилища по прежнему будет использоваться БД Redis, но для каждого региона отдельный экземпляр Redis-сервера. 
Параметры соединения к серверам отдельных сегментов будут передаваться через переменные окружения (*Environment Variables*) в формате *DB_{REGION}={host:port}*

Например:
```
DB_RUS=localhost:6000
DB_EU=localhost:6001
DB_OTHER=localhost:6002
```

Ключём сегментирования (*ShardKey*) будет выступать идентификатор текста, генерируемый в начале обработки запроса.
Сегментирование должно быть реализовано на стратегии поиска, т.е. по идентификатору текста необходимо в карте сегментирования найти идентификатор сегмента и затем обратиться к соответствующему серверу БД для записи или чтения данных.

Карту сегментирования можно сохранять в центральном хранилище, в котором до этого сохранялись все наши данные.

#### Логи

В каждом компоненте, который обращается к БД, должен выводиться лог в формате:

*LOOKUP: {идентификатор текста},  {идентификатор сегмента}*.

Например: 

**LOOKUP: 9B2FA05D-C54D-427F-B443-2B912D96AAA6, RUS**

### О масштабировании хранилища

Централизованое хранилище данных в системах, оперирующих большим объёмом данных, сталкивается со следующими ограничениями:
1. Ограниченный объём хранилища
2. Ограниченные вычислительные ресурсы
3. Ограниченная пропускная способность сети
4. Региональные особенности работы с данными.

Вертикальное масштабирование дискового пространства, процессорных мощностей и пропускной способности сетевых соединений способно отложить на некоторое время проблемы с вышеуказанными ограничениями (но вопросы региональных особенностей функционирования при этом по прежнему остаются).

Одним из способов решения проблем с ограничениями является разбиение данных на сегменты и размещение сегментов на отдельных серверах БД. Сегментирование относится к горизонтальному виду масштабирования, т.к. все сегменты имеют идентичную структуру и предназначение. Необходимо иметь ввиду, что сегменты являются виртуальными единицами разбиения, и на одном физическом сервере можно (и обычно так делается) разместить несколько сегментов данных. Сегментирование часто называют *шардингом*, а сегменты соответственно *шардами* (*shard*).

Для организации сегментирования данных необходимо:
1. Выбрать атрибут данных, по которому будет определяться принадлежность сегменту. Этот атрибут будет являться ключём сегментирования (*ShardKey*).
2. Выбрать стратегию сегментирования. Стратегия сегментирования может быть реализована как в приложении, так и непосредственно в хранилище данных, если оно поддерживает прозрачность распределения данных.

#### Виды стратегий сегментирования:

##### Стратегия поиска

Обеспечивает максимальный контроль над настройкой и использованием сегментов. Стратегия основана на карте сопоставления данных определённым сегментам (*ShardMap*). Из-за необходимости постоянного обращения к данной карте этап поиска для маршрутизации запросов создаёт дополнительные накладные расходы.

##### Стратегия диапазонов

Легко реализуется, не вносит дополнительных существенных накладных расходов, поэтому работает быстро. Подходит в случае, если множество значений ключа сегментирования можно разбить на диапазоны. Например, это может быть дата создания заказа, числовой идентификатор сущности и т.д.
Основной недостаток: стратегия не позволяет обеспечить оптимальную балансировку между сегментами в случае, если данные по диапазону распределены неравномерно, т.е. один диапазон может содержать большое количество записей (*быть перегретым*), другой быть сильно разреженным.

##### Стратегия хэширования

 Быстрый алгоритм, позволяющий  равномерно распределять данные и нагрузку по сегментам в случае хорошей хэш-функции. Но, по сравнению с другими методами, процесс пересегментирования более сложен, а иногда вовсе невозможен без полной остановки работы приложения. Поэтому выбирать хэш-функцию необходимо с особой тщательностью.

Выбор стратегии сегментирования и ключа сегментирования всегда индивидуален и зависит от решаемых задач.

### Ссылки
1. Описание шаблона "Сегментирование" https://docs.microsoft.com/en-us/azure/architecture/patterns/sharding
